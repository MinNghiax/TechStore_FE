<nav class="breadcrumb">
  <a class="breadcrumb-link" [routerLink]="['/home/list']" [routerLinkActive]="'active-link'"
    style="font-size: small; margin-left: 50px;">Trang Ch·ªß</a>
  <label class="small" style="font-size: small;"> > Chi ti·∫øt v·ªÅ <strong>{{product.product_name}}</strong></label>
</nav>

<div class="product-detail-container">
  <div class="product-image-container">
    <img [src]="product.PathAnh" alt="{{ product.product_name }}" class="product-image">
  </div>

  <div class="product-info">
    <h1 class="product-title">{{ product.product_name }}</h1>
    <p class="product-price">Gi√°: {{ product.price | currency:'VND' }}</p>

    <div class="product-description">
      <h3>M√¥ t·∫£ s·∫£n ph·∫©m</h3>
      {{product.description}}
    </div>

    <div class="product-specs">
      <h3>Th√¥ng s·ªë k·ªπ thu·∫≠t</h3>
      <ul>
        <li><strong>M√†n h√¨nh:</strong> Super Retina XDR 6.7 inch, 120Hz</li>
        <li><strong>Chip:</strong> Apple A17 Pro</li>
        <li><strong>RAM:</strong> 8GB</li>
        <li><strong>B·ªô nh·ªõ:</strong> 128GB / 256GB / 512GB / 1TB</li>
        <li><strong>Camera:</strong> 48MP + 12MP + 12MP / Tr∆∞·ªõc: 12MP</li>
        <li><em>B·∫°n vui l√≤ng li√™n h·ªá <strong>Chatbot</strong> ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n th√™m c√°c th√¥ng s·ªë k·ªπ thu·∫≠t chi ti·∫øt c·ªßa
            s·∫£n ph·∫©m n√†y nh√©!</em></li>
      </ul>

    </div>

    <div class="product-actions">
      <button class="btn-add-to-cart" (click)="addToCart()">Th√™m v√†o gi·ªè h√†ng <i
          class="fa fa-shopping-cart"></i></button>
      <button type="button" class="btn-buy-now" data-bs-toggle="modal" data-bs-target="#exampleModal"
        (click)="themDon()">Mua ngay</button>
    </div>
  </div>
</div>

<!-- Modal Thanh to√°n -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
  *ngIf="userService.getCurrentUser() && dangThemSua">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Thanh to√°n ƒë∆°n h√†ng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" (click)="dong()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="showSuccessMessage" class="alert alert-success text-center">
          ƒê·∫∑t h√†ng th√†nh c√¥ng! <br> Vui l√≤ng ch·ªù...
        </div>

        <div *ngIf="errorMessage && dangThemSua" class="alert alert-danger">
          {{ errorMessage }}
        </div>

        <div *ngIf="bankInfo && transferInstructions" class="alert alert-info text-center">
          <h5>H∆∞·ªõng d·∫´n chuy·ªÉn kho·∫£n</h5>
          <p>Qu√©t m√£ QR, nh·∫≠p th√¥ng tin chuy·ªÉn kho·∫£n:</p>
          <img [src]="qrCodeUrl" style="width: 250px; height: 250px; display: block; margin: 0 auto;"
            (error)="qrCodeUrl = 'assets/images/default-image.jpg'; errorMessage = 'Kh√¥ng th·ªÉ t·∫£i m√£ QR!'" />
          <pre class="mt-3">{{ bankInfo }}</pre>
          <p>{{ transferInstructions }}</p>
          <button class="btn btn-primary mt-3" (click)="confirmTransfer()">ƒê√£ hi·ªÉu</button>
        </div>

        <div *ngIf="selectedItem && !showSuccessMessage && !bankInfo; else noSelection">
          <table class="table">
            <thead>
              <tr>
                <th>H√¨nh ·∫£nh</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><img [src]="selectedItem.PathAnh" width="50"
                    (error)="selectedItem.PathAnh = 'assets/images/default-image.jpg'" /></td>
                <td>{{ selectedItem.product.product_name }}</td>
                <td>
                  <input type="number" [(ngModel)]="selectedItem.quantity" min="1"
                    (change)="selectedItem.total_amount = selectedItem.price * selectedItem.quantity" />
                </td>
                <td>{{ selectedItem.price | currency:'VND' }}</td>
                <td>{{ selectedItem.total_amount | currency:'VND' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noSelection>
          <p>Vui l√≤ng ch·ªçn m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.</p>
        </ng-template>

        <form #paymentForm="ngForm" *ngIf="dangThemSua && !bankInfo && !showSuccessMessage"
          (ngSubmit)="muaNgay(paymentForm)">
          <div class="mb-3">
            <label for="fullname" class="form-label">H·ªç t√™n:</label>
            <input type="text" id="fullname" name="fullname" class="form-control" ngModel required
              pattern="[A-Za-z√Ä-·ªπ\s]+" />
            <div *ngIf="paymentForm.controls['fullname']?.touched && paymentForm.controls['fullname']?.invalid"
              class="text-danger">
              H·ªç t√™n ch·ªâ ch·ª©a ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng.
            </div>
          </div>
          <div class="mb-3">
            <label for="address" class="form-label">ƒê·ªãa ch·ªâ:</label>
            <input type="text" id="address" name="address" class="form-control" ngModel required minlength="5" />
            <div *ngIf="paymentForm.controls['address']?.touched && paymentForm.controls['address']?.invalid"
              class="text-danger">
              ƒê·ªãa ch·ªâ √≠t nh·∫•t 5 k√Ω t·ª±.
            </div>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="text" id="phone" name="phone" class="form-control" ngModel required pattern="[0-9]{10}" />
            <div *ngIf="paymentForm.controls['phone']?.touched && paymentForm.controls['phone']?.invalid"
              class="text-danger">
              S·ªë ƒëi·ªán tho·∫°i ph·∫£i 10 ch·ªØ s·ªë.
            </div>
          </div>
          <div class="mb-3">
            <label for="payment" class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
            <select id="payment" name="payment" class="form-select" ngModel required>
              <option value="COD">Thanh to√°n khi nh·∫≠n h√†ng</option>
              <option value="Banking">Chuy·ªÉn kho·∫£n</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" [disabled]="!paymentForm.valid">X√°c nh·∫≠n</button>
          <button type="button" class="btn btn-secondary ms-2" (click)="dong()">H·ªßy</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ƒê√°nh gi√° s·∫£n ph·∫©m -->
<div class="review-container">
  <h4>ƒê√°nh gi√° s·∫£n ph·∫©m c·ªßa b·∫°n</h4>
  <div class="review-form">
    <textarea [(ngModel)]="newReview" placeholder="H√£y ƒë·ªÉ l·∫°i b√¨nh lu·∫≠n t·∫°i ƒë√¢y!"></textarea>
    <div class="rating">
      <label>Rating:</label>
      <select [(ngModel)]="rating">
        <option *ngFor="let star of [1, 2, 3, 4, 5]" [value]="star">{{ star }} ‚òÖ</option>
      </select>
    </div>
    <button class="btn btn-primary" (click)="submitReview()">G·ª≠i</button>
  </div>

  <div class="review-item" *ngFor="let r of reviews">
    <p><strong><i class="fas fa-user"></i> {{ r.username }}</strong></p>
    <p>ƒê√°nh gi√°: {{ r.rating }} ‚≠ê</p>
    <p>{{ r.content }}</p>
    <p class="review-time">üïí {{ r.create_at | date:'HH:mm dd/MM/yyyy' }}</p>


    <button *ngIf="r.user_id === currentUserId || isAdmin" type="button" class="btn btn-sm btn-danger"
      data-bs-toggle="modal" data-bs-target="#addModal" (click)="editReview(r)">
      <i class="fas fa-pen"></i>
    </button>
    <button *ngIf="r.user_id === currentUserId || isAdmin" type="button" class="btn btn-sm btn-warning ms-2"
      (click)="deleteReview(r.id)">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</div>

<!-- Modal s·ª≠a ƒë√°nh gi√° -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form *ngIf="selectedReview" (ngSubmit)="suaReview()" #editReviewForm="ngForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">S·ª≠a ƒë√°nh gi√°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">N·ªôi dung</label>
            <input type="text" class="form-control" [(ngModel)]="contenReview" name="Content" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Rating</label>
            <select class="form-control" [(ngModel)]="ratingReview" name="Rating" required>
              <option *ngFor="let star of [1,2,3,4,5]" [value]="star">{{ star }} ‚òÖ</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" [disabled]="!editReviewForm.form.valid" (click)="suaReview()"
            data-bs-dismiss="modal">
            C·∫≠p nh·∫≠t
          </button>
        </div>

      </div>
    </form>
  </div>
</div>